{% extends "base_tailwind.html" %}
{% load static %}

{% block title %}Invoice Lookup - Eclipse{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white p-8" x-data="invoiceLookup()">
    {% csrf_token %}

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                Invoice Look Up
            </h1>
            <p class="text-gray-400 mt-2">Search for customer invoices and view PDFs</p>
        </div>

        <!-- Customer Search -->
        <div class="bg-slate-800/50 rounded-xl p-6 border border-white/10 mb-6">
            <label class="block text-sm font-medium mb-2">Search for Customer</label>
            <div class="relative">
                <input
                    type="text"
                    x-model="customerSearch"
                    @input="searchCustomers()"
                    @focus="showDropdown = true"
                    @keydown.down.prevent="highlightedIndex = Math.min(highlightedIndex + 1, searchResults.length - 1)"
                    @keydown.up.prevent="highlightedIndex = Math.max(highlightedIndex - 1, 0)"
                    @keydown.enter.prevent="if (searchResults[highlightedIndex]) selectCustomer(searchResults[highlightedIndex])"
                    @keydown.escape="showDropdown = false"
                    placeholder="Enter customer name or ID..."
                    class="w-full px-4 py-3 bg-slate-700 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <div x-show="searching" class="absolute right-3 top-3">
                    <svg class="animate-spin h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>

                <!-- Search Results Dropdown -->
                <div
                    x-show="showDropdown && searchResults.length > 0"
                    @click.away="showDropdown = false"
                    class="absolute z-10 w-full mt-2 bg-slate-700 border border-white/20 rounded-lg shadow-xl max-h-64 overflow-y-auto"
                >
                    <template x-for="(customer, index) in searchResults" :key="customer.id">
                        <button
                            @click="selectCustomer(customer)"
                            :class="index === highlightedIndex ? 'bg-slate-600 ring-2 ring-blue-500' : 'hover:bg-slate-600'"
                            class="w-full text-left p-4 border-b border-white/10 transition-colors"
                        >
                            <div class="font-semibold" x-text="customer.nameIndex || customer.name"></div>
                            <div class="text-sm text-gray-400" x-text="customer.id"></div>
                        </button>
                    </template>
                </div>
            </div>
        </div>

        <!-- Customer Info Card -->
        <div x-show="customerInfo" class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 mb-6 shadow-xl">
            <div class="flex items-center mb-4">
                <div class="bg-white/20 rounded-lg p-3 mr-4">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                </div>
                <div>
                    <h2 class="text-2xl font-bold" x-text="customerInfo?.name"></h2>
                    <p class="text-blue-100 text-sm">Customer ID: <span x-text="customerInfo?.id"></span></p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <div class="bg-white/10 rounded-lg p-4">
                    <h3 class="font-semibold mb-2 flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Address
                    </h3>
                    <div class="text-sm text-blue-50">
                        <p x-text="customerInfo?.addressLine1"></p>
                        <p x-show="customerInfo?.addressLine2" x-text="customerInfo?.addressLine2"></p>
                        <p><span x-text="customerInfo?.city"></span>, <span x-text="customerInfo?.state"></span> <span x-text="customerInfo?.postalCode"></span></p>
                    </div>
                </div>

                <div class="bg-white/10 rounded-lg p-4" x-show="customerInfo?.phones?.length || customerInfo?.emails?.length">
                    <h3 class="font-semibold mb-2 flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                        Contact
                    </h3>
                    <div class="text-sm text-blue-50">
                        <p x-show="customerInfo?.phones?.length" class="flex items-center mb-1">
                            <svg class="w-3 h-3 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                            </svg>
                            <span x-text="customerInfo?.phones?.[0]?.number"></span>
                        </p>
                        <p x-show="customerInfo?.emails?.length" class="flex items-center">
                            <svg class="w-3 h-3 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <span x-text="customerInfo?.emails?.[0]?.address"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div x-show="errorMessage" class="bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg mb-6">
            <span x-text="errorMessage"></span>
        </div>

        <!-- Invoice Table -->
        <div x-show="invoices.length > 0" class="bg-slate-800/50 rounded-xl border border-white/10 overflow-hidden">
            <!-- Results Info -->
            <div class="px-6 py-3 bg-slate-700/50 border-b border-white/10">
                <p class="text-sm text-gray-300 text-center">
                    Page <span x-text="currentPage"></span> (<span x-text="invoices.length"></span> results<span x-show="hasMorePages">, more available</span>)
                </p>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gradient-to-r from-blue-600 to-purple-600">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Invoice Date</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">Invoice Number</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">PO Number</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider">PDF</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/10">
                        <template x-for="(invoice, index) in invoices" :key="index">
                            <tr class="hover:bg-slate-700/30 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap" x-text="formatDate(invoice.shipDate)"></td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="invoice.fullInvoiceID"></td>
                                <td class="px-6 py-4 whitespace-nowrap" x-text="invoice.poNumber"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <button
                                        @click="viewPDF(invoice.fullInvoiceID)"
                                        :disabled="pdfLoading === invoice.fullInvoiceID"
                                        class="px-3 py-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 rounded text-sm font-medium transition-colors"
                                    >
                                        <span x-show="pdfLoading !== invoice.fullInvoiceID">View PDF</span>
                                        <span x-show="pdfLoading === invoice.fullInvoiceID">Loading...</span>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div x-show="invoices.length === pageSize || currentPage > 1" class="px-6 py-4 bg-slate-700/50 border-t border-white/10 flex justify-center items-center gap-4">
                <button
                    @click="goToPreviousPage()"
                    :disabled="currentPage === 1"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded font-medium transition-colors"
                >
                    ← Previous
                </button>
                <span class="text-sm font-medium">Page <span x-text="currentPage"></span></span>
                <button
                    @click="goToNextPage()"
                    :disabled="!hasMorePages"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded font-medium transition-colors"
                >
                    Next →
                </button>
            </div>
        </div>

        <!-- No Results -->
        <div x-show="!loading && searchExecuted && invoices.length === 0" class="text-center py-12 text-gray-400">
            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p>No invoices found for this customer.</p>
        </div>
    </div>
</div>

<script>
function invoiceLookup() {
    return {
        customerSearch: '',
        searchResults: [],
        searching: false,
        showDropdown: false,
        highlightedIndex: 0,
        searchTimeout: null,

        customerInfo: null,
        selectedCustomerId: null,

        invoices: [],
        loading: false,
        searchExecuted: false,
        errorMessage: '',

        currentPage: 1,
        pageSize: 25,
        hasMorePages: false,

        pdfLoading: null,

        searchCustomers() {
            clearTimeout(this.searchTimeout);

            if (!this.customerSearch || this.customerSearch.length < 2) {
                this.searchResults = [];
                this.showDropdown = false;
                return;
            }

            this.searchTimeout = setTimeout(async () => {
                this.searching = true;
                this.highlightedIndex = 0;

                try {
                    const response = await fetch(`/invoices/api/customers/search/?keyword=${encodeURIComponent(this.customerSearch)}`);
                    const data = await response.json();

                    if (data.success) {
                        this.searchResults = data.results;
                        this.showDropdown = true;
                    }
                } catch (error) {
                    console.error('Customer search error:', error);
                } finally {
                    this.searching = false;
                }
            }, 1000);
        },

        async selectCustomer(customer) {
            this.selectedCustomerId = customer.id;
            this.customerSearch = customer.nameIndex || customer.name;
            this.showDropdown = false;
            this.currentPage = 1;

            // Fetch customer details
            try {
                const response = await fetch(`/invoices/api/customers/${encodeURIComponent(customer.id)}/`);
                const data = await response.json();

                if (data.success) {
                    this.customerInfo = data.customer;
                    this.fetchInvoices();
                }
            } catch (error) {
                console.error('Failed to fetch customer details:', error);
                this.errorMessage = 'Failed to load customer details';
            }
        },

        async fetchInvoices() {
            if (!this.selectedCustomerId) return;

            this.loading = true;
            this.errorMessage = '';

            try {
                const startIndex = (this.currentPage - 1) * this.pageSize;
                const response = await fetch(
                    `/invoices/api/invoices/search/?shipToId=${encodeURIComponent(this.selectedCustomerId)}&startIndex=${startIndex}&pageSize=${this.pageSize}`
                );
                const data = await response.json();

                if (data.success) {
                    this.invoices = data.invoices;
                    this.hasMorePages = data.invoices.length === this.pageSize;
                    this.searchExecuted = true;

                    if (this.invoices.length === 0) {
                        this.errorMessage = `No invoices found for ${this.customerInfo?.name}`;
                    }
                } else {
                    this.errorMessage = data.error || 'Failed to fetch invoices';
                }
            } catch (error) {
                console.error('Invoice fetch error:', error);
                this.errorMessage = 'Failed to retrieve invoices';
            } finally {
                this.loading = false;
            }
        },

        goToNextPage() {
            if (this.hasMorePages) {
                this.currentPage++;
                this.fetchInvoices();
            }
        },

        goToPreviousPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.fetchInvoices();
            }
        },

        async viewPDF(fullInvoiceID) {
            try {
                this.pdfLoading = fullInvoiceID;

                const response = await fetch(`/invoices/api/invoices/pdf/${encodeURIComponent(fullInvoiceID)}/`);

                if (!response.ok) {
                    throw new Error('Failed to load PDF');
                }

                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                window.open(blobUrl, '_blank');

                setTimeout(() => {
                    window.URL.revokeObjectURL(blobUrl);
                }, 10000);
            } catch (error) {
                console.error('PDF fetch error:', error);
                alert('Failed to load PDF. Please try again.');
            } finally {
                this.pdfLoading = null;
            }
        },

        formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                return new Date(dateString).toLocaleDateString();
            } catch (e) {
                return dateString;
            }
        }
    };
}
</script>
{% endblock %}
