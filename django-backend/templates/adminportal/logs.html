{% extends "base_tailwind.html" %}

{% block title %}System Logs - EMP54 Admin{% endblock %}

{% block content %}
<div class="space-y-6" x-data="logsViewer()">

    <!-- Header -->
    <div class="flex items-center justify-between">
        <h1 class="text-3xl font-bold flex items-center">
            <svg class="w-8 h-8 mr-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            System Logs
        </h1>
    </div>

    <!-- Filters -->
    <div class="glass-effect rounded-xl p-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Type Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Filter by Type</label>
                <select
                    x-model="selectedType"
                    class="w-full px-4 py-2 bg-gray-800/50 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                    <option value="">All Types</option>
                    <option value="login">Login</option>
                    <option value="login-failure">Login Failure</option>
                    <option value="file-upload">File Upload</option>
                    <option value="surcharge">Surcharge</option>
                </select>
            </div>

            <!-- Email Filter -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Filter by Email</label>
                <input
                    type="text"
                    x-model="emailFilter"
                    placeholder="user@example.com"
                    class="w-full px-4 py-2 bg-gray-800/50 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
            </div>

            <!-- Apply Button -->
            <div class="flex items-end">
                <button
                    @click="fetchLogs()"
                    :disabled="loading"
                    class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg font-medium transition-colors flex items-center justify-center"
                >
                    <svg x-show="loading" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span x-text="loading ? 'Loading...' : 'Apply Filters'"></span>
                </button>
            </div>

            <!-- Refresh Button -->
            <div class="flex items-end">
                <button
                    @click="fetchLogs()"
                    :disabled="loading"
                    class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed rounded-lg font-medium transition-colors"
                >
                    Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Logs Table -->
    <div class="glass-effect rounded-xl overflow-hidden">
        <!-- Table Header -->
        <div class="bg-gray-800/70 px-6 py-3 border-b border-gray-700">
            <div class="grid grid-cols-12 gap-4 text-sm font-semibold text-gray-300">
                <div class="col-span-2">Timestamp</div>
                <div class="col-span-2">User</div>
                <div class="col-span-1">Company</div>
                <div class="col-span-1">Type</div>
                <div class="col-span-3">Message</div>
                <div class="col-span-3">Meta Info</div>
            </div>
        </div>

        <!-- Table Body -->
        <div class="overflow-y-auto" style="max-height: 600px;">
            <template x-if="logs.length === 0 && !loading">
                <div class="px-6 py-12 text-center text-gray-400">
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p class="text-lg">No logs found</p>
                </div>
            </template>

            <template x-for="log in logs" :key="log._id">
                <div class="grid grid-cols-12 gap-4 px-6 py-4 border-b border-gray-700/50 hover:bg-gray-800/30 transition-colors text-sm">
                    <!-- Timestamp -->
                    <div class="col-span-2 text-gray-300">
                        <span x-text="formatTimestamp(log.timestamp)"></span>
                    </div>

                    <!-- User -->
                    <div class="col-span-2 text-gray-300 truncate" :title="log.userEmail">
                        <span x-text="log.userEmail"></span>
                    </div>

                    <!-- Company -->
                    <div class="col-span-1">
                        <span
                            class="inline-block px-2 py-1 text-xs font-medium rounded bg-purple-600/20 text-purple-400"
                            x-text="log.companyCode"
                        ></span>
                    </div>

                    <!-- Type -->
                    <div class="col-span-1">
                        <span
                            class="inline-block px-2 py-1 text-xs font-medium rounded"
                            :class="{
                                'bg-green-600/20 text-green-400': log.type === 'login',
                                'bg-red-600/20 text-red-400': log.type === 'login-failure',
                                'bg-blue-600/20 text-blue-400': log.type === 'file-upload',
                                'bg-yellow-600/20 text-yellow-400': log.type === 'surcharge'
                            }"
                            x-text="log.type"
                        ></span>
                    </div>

                    <!-- Message -->
                    <div class="col-span-3 text-gray-400">
                        <span x-text="log.message"></span>
                    </div>

                    <!-- Meta Info -->
                    <div class="col-span-3 flex flex-wrap gap-1">
                        <span
                            x-show="log.meta && log.meta.ip"
                            class="inline-block px-2 py-1 text-xs font-medium rounded bg-indigo-600/20 text-indigo-400"
                        >
                            IP: <span x-text="log.meta.ip"></span>
                        </span>
                        <span
                            x-show="log.meta && log.meta.method"
                            class="inline-block px-2 py-1 text-xs font-medium rounded bg-purple-600/20 text-purple-400"
                        >
                            Method: <span x-text="log.meta.method"></span>
                        </span>
                    </div>
                </div>
            </template>
        </div>
    </div>

</div>

<script>
function logsViewer() {
    return {
        logs: [],
        loading: false,
        selectedType: '',
        emailFilter: '',

        async fetchLogs() {
            this.loading = true;
            try {
                const params = new URLSearchParams();
                if (this.selectedType) params.append('type', this.selectedType);
                if (this.emailFilter) params.append('email', this.emailFilter);

                const response = await fetch(`/admin/api/logs?${params.toString()}`);
                if (!response.ok) throw new Error('Failed to fetch logs');

                this.logs = await response.json();
                console.log('[Logs] Loaded', this.logs.length, 'logs');
            } catch (err) {
                console.error('[Logs] Error:', err);
                alert('Failed to fetch logs: ' + err.message);
            } finally {
                this.loading = false;
            }
        },

        formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            return new Date(timestamp).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        },

        init() {
            this.fetchLogs();
        }
    }
}
</script>
{% endblock %}
