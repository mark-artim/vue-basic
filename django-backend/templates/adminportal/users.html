{% extends "base_tailwind.html" %}

{% block title %}User Management - EMP54 Admin{% endblock %}

{% block content %}
<div class="space-y-6" x-data="userManager()">

    <!-- Header -->
    <div class="flex items-center justify-between">
        <h1 class="text-3xl font-bold flex items-center">
            <svg class="w-8 h-8 mr-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
            User Management
        </h1>
        <button
            @click="openAddDialog()"
            class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors flex items-center space-x-2"
        >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span>Add User</span>
        </button>
    </div>

    <!-- Users Table -->
    <div class="glass-effect rounded-xl overflow-hidden">
        <!-- Table Header -->
        <div class="bg-gray-800/70 px-6 py-3 border-b border-gray-700">
            <div class="grid grid-cols-12 gap-4 text-sm font-semibold text-gray-300">
                <div class="col-span-3">Email</div>
                <div class="col-span-2">Name</div>
                <div class="col-span-2">Company</div>
                <div class="col-span-1">Type</div>
                <div class="col-span-2">Products</div>
                <div class="col-span-2">Actions</div>
            </div>
        </div>

        <!-- Table Body -->
        <div class="overflow-y-auto" style="max-height: 600px;">
            <template x-if="users.length === 0 && !loading">
                <div class="px-6 py-12 text-center text-gray-400">
                    <p class="text-lg">No users found</p>
                </div>
            </template>

            <template x-for="user in users" :key="user._id">
                <div class="grid grid-cols-12 gap-4 px-6 py-4 border-b border-gray-700/50 hover:bg-gray-800/30 transition-colors text-sm">
                    <!-- Email -->
                    <div class="col-span-3 text-gray-300" x-text="user.email"></div>

                    <!-- Name -->
                    <div class="col-span-2 text-gray-300">
                        <span x-text="user.firstName + ' ' + user.lastName"></span>
                    </div>

                    <!-- Company -->
                    <div class="col-span-2">
                        <span class="inline-block px-2 py-1 text-xs font-medium rounded bg-purple-600/20 text-purple-400" x-text="user.companyId?.name || 'â€”'"></span>
                    </div>

                    <!-- Type -->
                    <div class="col-span-1">
                        <span
                            class="inline-block px-2 py-1 text-xs font-medium rounded"
                            :class="{
                                'bg-blue-600/20 text-blue-400': user.userType === 'admin',
                                'bg-green-600/20 text-green-400': user.userType === 'customer'
                            }"
                            x-text="user.userType"
                        ></span>
                    </div>

                    <!-- Products -->
                    <div class="col-span-2 text-xs text-gray-400">
                        <span x-text="(user.products || []).length + ' products'"></span>
                    </div>

                    <!-- Actions -->
                    <div class="col-span-2 flex space-x-2">
                        <button
                            @click="openEditDialog(user)"
                            class="px-3 py-1 bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 rounded transition-colors"
                        >
                            Edit
                        </button>
                        <button
                            @click="confirmDelete(user)"
                            class="px-3 py-1 bg-red-600/20 hover:bg-red-600/40 text-red-400 rounded transition-colors"
                        >
                            Delete
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Add/Edit Dialog -->
    <div
        x-show="showDialog"
        class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
        style="display: none;"
        @click.self="closeDialog()"
    >
        <div class="glass-effect rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-white mb-6" x-text="form._id ? 'Edit User' : 'Add User'"></h2>

                <!-- Error Message -->
                <div x-show="errorMessage" class="mb-4 p-4 bg-red-600/20 border border-red-600/50 rounded-lg text-red-400 text-sm">
                    <span x-text="errorMessage"></span>
                </div>

                <!-- Success Message -->
                <div x-show="successMessage" class="mb-4 p-4 bg-green-600/20 border border-green-600/50 rounded-lg text-green-400 text-sm">
                    <span x-text="successMessage"></span>
                </div>

                <form @submit.prevent="saveUser()">
                    <div class="space-y-4">
                        <!-- Email -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                            <input
                                type="email"
                                x-model="form.email"
                                required
                                class="w-full px-4 py-2 bg-gray-800/50 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>

                        <!-- First Name & Last Name -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">First Name</label>
                                <input
                                    type="text"
                                    x-model="form.firstName"
                                    required
                                    class="w-full px-4 py-2 bg-gray-800/50 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Last Name</label>
                                <input
                                    type="text"
                                    x-model="form.lastName"
                                    required
                                    class="w-full px-4 py-2 bg-gray-800/50 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                >
                            </div>
                        </div>

                        <!-- User Type -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">User Type</label>
                            <select
                                x-model="form.userType"
                                required
                                @change="onUserTypeChange()"
                                class="w-full px-4 py-2 bg-gray-800/50 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                                <option value="">Select Type</option>
                                <option value="admin">Admin</option>
                                <option value="customer">Customer</option>
                            </select>
                        </div>

                        <!-- Password (Admin Only) -->
                        <div x-show="form.userType === 'admin'">
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                <span x-text="form._id ? 'Reset Password (leave blank to keep current)' : 'Password'"></span>
                            </label>
                            <input
                                type="password"
                                x-model="form.password"
                                :required="form.userType === 'admin' && !form._id"
                                class="w-full px-4 py-2 bg-gray-800/50 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>

                        <!-- ERP Username (Customer Only) -->
                        <div x-show="form.userType === 'customer'">
                            <label class="block text-sm font-medium text-gray-300 mb-2">ERP Username</label>
                            <input
                                type="text"
                                x-model="form.erpUserName"
                                :required="form.userType === 'customer'"
                                class="w-full px-4 py-2 bg-gray-800/50 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>

                        <!-- Company (Customer Only) -->
                        <div x-show="form.userType === 'customer'">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Company</label>
                            <select
                                x-model="form.companyId"
                                :required="form.userType === 'customer'"
                                @change="onCompanyChange()"
                                class="w-full px-4 py-2 bg-gray-800/50 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                                <option value="">Select Company</option>
                                <template x-for="company in companies">
                                    <option :value="company._id" x-text="company.name"></option>
                                </template>
                            </select>
                        </div>

                        <!-- Products -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Products</label>
                            <div class="bg-gray-800/50 border border-gray-600 rounded-lg p-4 space-y-2 max-h-48 overflow-y-auto">
                                <template x-for="product in availableProducts" :key="product._id">
                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-700/30 p-2 rounded">
                                        <input
                                            type="checkbox"
                                            :value="product._id"
                                            :checked="form.products.includes(product._id)"
                                            @change="toggleProduct(product._id)"
                                            class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500"
                                        >
                                        <span class="text-sm text-gray-300" x-text="product.name"></span>
                                    </label>
                                </template>
                                <template x-if="availableProducts.length === 0">
                                    <p class="text-sm text-gray-500">
                                        <span x-show="form.userType === 'customer' && !form.companyId">Select a company first</span>
                                        <span x-show="form.userType === 'customer' && form.companyId">No products available for this company</span>
                                        <span x-show="form.userType === 'admin'">All products available for admin users</span>
                                    </p>
                                </template>
                            </div>
                        </div>

                        <!-- Show Unavailable Products Toggle -->
                        <div>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input
                                    type="checkbox"
                                    x-model="form.showUnavailableProducts"
                                    class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500"
                                >
                                <span class="text-sm text-gray-300">Show unavailable products on dashboard</span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1 ml-6">When enabled, user will see products they don't have access to</p>
                        </div>

                        <!-- Email Invite Section (Edit Only) -->
                        <div x-show="form._id" class="pt-4 border-t border-gray-700">
                            <h3 class="text-lg font-semibold text-white mb-3">Send Invite Email</h3>
                            <div class="space-y-3">
                                <select
                                    x-model="inviteType"
                                    class="w-full px-4 py-2 bg-gray-800/50 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                >
                                    <option value="standard">Standard Invite</option>
                                    <option value="heritage">Heritage Invite</option>
                                </select>
                                <button
                                    type="button"
                                    @click="sendInvite()"
                                    :disabled="sendingInvite"
                                    class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-medium rounded-lg transition-colors"
                                >
                                    <span x-show="!sendingInvite">Send Invite</span>
                                    <span x-show="sendingInvite">Sending...</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-end space-x-3 mt-6">
                        <button
                            type="button"
                            @click="closeDialog()"
                            class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors"
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            :disabled="saving"
                            class="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-medium rounded-lg transition-colors"
                        >
                            <span x-show="!saving">Save</span>
                            <span x-show="saving">Saving...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Dialog -->
    <div
        x-show="showDeleteDialog"
        class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
        style="display: none;"
        @click.self="closeDeleteDialog()"
    >
        <div class="glass-effect rounded-xl max-w-md w-full p-6">
            <h2 class="text-xl font-bold text-white mb-4">Confirm Delete</h2>
            <p class="text-gray-300 mb-6">
                Are you sure you want to delete user <span class="font-semibold" x-text="userToDelete?.email"></span>?
            </p>
            <div class="flex justify-end space-x-3">
                <button
                    @click="closeDeleteDialog()"
                    class="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors"
                >
                    Cancel
                </button>
                <button
                    @click="deleteUser()"
                    :disabled="deleting"
                    class="px-6 py-2 bg-red-600 hover:bg-red-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-medium rounded-lg transition-colors"
                >
                    <span x-show="!deleting">Delete</span>
                    <span x-show="deleting">Deleting...</span>
                </button>
            </div>
        </div>
    </div>

</div>

<script>
function userManager() {
    return {
        users: [],
        companies: [],
        allProducts: [],
        showDialog: false,
        showDeleteDialog: false,
        loading: false,
        saving: false,
        deleting: false,
        sendingInvite: false,
        errorMessage: '',
        successMessage: '',
        inviteType: 'standard',
        userToDelete: null,

        form: {
            _id: null,
            email: '',
            firstName: '',
            lastName: '',
            userType: '',
            erpUserName: '',
            password: '',
            companyId: '',
            products: [],
            roles: {},
            showUnavailableProducts: false
        },

        get availableProducts() {
            if (this.form.userType === 'admin') {
                // Admin users see all products
                return this.allProducts
            } else if (this.form.userType === 'customer' && this.form.companyId) {
                // Customer users see only their company's products
                const company = this.companies.find(c => c._id === this.form.companyId)
                return company?.products || []
            }
            return []
        },

        async init() {
            await this.loadUsers()
            await this.loadCompanies()
            await this.loadProducts()
        },

        async loadUsers() {
            try {
                const response = await fetch('/admin/api/users/')
                this.users = await response.json()
                console.log('[Users] Loaded', this.users.length, 'users')
            } catch (err) {
                console.error('[Users] Error:', err)
                alert('Failed to load users')
            }
        },

        async loadCompanies() {
            try {
                const response = await fetch('/admin/api/companies/')
                this.companies = await response.json()
                console.log('[Companies] Loaded', this.companies.length, 'companies')
            } catch (err) {
                console.error('[Companies] Error:', err)
            }
        },

        async loadProducts() {
            try {
                const response = await fetch('/admin/api/products/')
                this.allProducts = await response.json()
                console.log('[Products] Loaded', this.allProducts.length, 'products')
            } catch (err) {
                console.error('[Products] Error:', err)
            }
        },

        openAddDialog() {
            this.form = {
                _id: null,
                email: '',
                firstName: '',
                lastName: '',
                userType: '',
                erpUserName: '',
                password: '',
                companyId: '',
                products: [],
                roles: {},
                showUnavailableProducts: false
            }
            this.errorMessage = ''
            this.successMessage = ''
            this.showDialog = true
        },

        openEditDialog(user) {
            this.form = {
                _id: user._id,
                email: user.email,
                firstName: user.firstName,
                lastName: user.lastName,
                userType: user.userType,
                erpUserName: user.erpUserName || '',
                password: '',
                companyId: user.companyId?._id || '',
                products: [...(user.products || [])],
                roles: JSON.parse(JSON.stringify(user.roles || {})),
                showUnavailableProducts: user.showUnavailableProducts || false
            }
            this.errorMessage = ''
            this.successMessage = ''
            this.inviteType = 'standard'
            this.showDialog = true
        },

        closeDialog() {
            this.showDialog = false
        },

        onUserTypeChange() {
            if (this.form.userType === 'admin') {
                this.form.companyId = ''
                this.form.erpUserName = ''
            } else {
                this.form.password = ''
            }
        },

        onCompanyChange() {
            // Clear products that are not in the new company
            const availableIds = this.availableProducts.map(p => p._id)
            this.form.products = this.form.products.filter(p => availableIds.includes(p))
        },

        toggleProduct(productId) {
            const index = this.form.products.indexOf(productId)
            if (index > -1) {
                this.form.products.splice(index, 1)
            } else {
                this.form.products.push(productId)
            }
        },

        async saveUser() {
            this.saving = true
            this.errorMessage = ''
            this.successMessage = ''

            try {
                const response = await fetch('/admin/api/users/save/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.form)
                })

                const data = await response.json()

                if (response.ok) {
                    this.successMessage = data.message || 'User saved successfully'
                    await this.loadUsers()
                    setTimeout(() => {
                        this.closeDialog()
                    }, 1500)
                } else {
                    this.errorMessage = data.error || 'Failed to save user'
                }
            } catch (err) {
                console.error('[Save User] Error:', err)
                this.errorMessage = 'Failed to save user: ' + err.message
            } finally {
                this.saving = false
            }
        },

        confirmDelete(user) {
            this.userToDelete = user
            this.showDeleteDialog = true
        },

        closeDeleteDialog() {
            this.showDeleteDialog = false
            this.userToDelete = null
        },

        async deleteUser() {
            if (!this.userToDelete) return

            this.deleting = true
            try {
                const response = await fetch(`/admin/api/users/${this.userToDelete._id}/delete/`, {
                    method: 'DELETE'
                })

                if (response.ok) {
                    await this.loadUsers()
                    this.closeDeleteDialog()
                } else {
                    const data = await response.json()
                    alert('Failed to delete user: ' + (data.error || 'Unknown error'))
                }
            } catch (err) {
                console.error('[Delete User] Error:', err)
                alert('Failed to delete user: ' + err.message)
            } finally {
                this.deleting = false
            }
        },

        async sendInvite() {
            if (!this.form._id || !this.form.email) return

            this.sendingInvite = true
            this.errorMessage = ''
            this.successMessage = ''

            try {
                const response = await fetch('/admin/api/users/invite/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        toEmail: this.form.email,
                        userId: this.form._id,
                        templateType: this.inviteType
                    })
                })

                const data = await response.json()

                if (response.ok) {
                    this.successMessage = `Invite sent to ${this.form.email}`
                    setTimeout(() => {
                        this.successMessage = ''
                    }, 5000)
                } else {
                    this.errorMessage = data.error || 'Failed to send invite'
                }
            } catch (err) {
                console.error('[Send Invite] Error:', err)
                this.errorMessage = 'Failed to send invite: ' + err.message
            } finally {
                this.sendingInvite = false
            }
        }
    }
}
</script>
{% endblock %}
