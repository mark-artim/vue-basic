{% extends "base_tailwind.html" %}

{% block title %}Product Search - EMP54 Portal{% endblock %}

{% block content %}
<div x-data="productSearch()">
    <div class="max-w-[95%] mx-auto">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            Product Search
        </h2>

        <!-- Search Card -->
        <div class="glass-effect rounded-xl p-6 mb-6">
            <h5 class="text-xl font-semibold text-white mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                Search Product
            </h5>
            <div class="relative">
                <input
                    type="text"
                    class="w-full px-4 py-3 pr-10 bg-slate-800/50 border border-slate-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                    placeholder="Type product ID or description..."
                    x-model="searchQuery"
                    @input="searchProducts()"
                    @keydown="handleKeydown($event)"
                    @focus="focusedIndex = -1"
                >
                <!-- Clear button -->
                <button
                    x-show="searchQuery"
                    @click="clearSearch()"
                    class="absolute right-2 top-1/2 transform -translate-y-1/2 p-1.5 bg-slate-700/80 hover:bg-slate-600 rounded text-gray-300 hover:text-white transition-all"
                    type="button"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <div x-show="searchResults.length > 0" class="absolute z-40 w-full mt-1 bg-slate-800/95 border border-slate-600 rounded-lg max-h-64 overflow-y-auto shadow-xl">
                    <template x-for="(product, index) in searchResults" :key="product.id">
                        <div
                            class="px-4 py-2 text-white cursor-pointer border-b border-slate-700 last:border-b-0 transition-colors hover:bg-slate-700/50"
                            :class="{ 'bg-slate-700/50': focusedIndex === index }"
                            @click="selectProduct(product)"
                            @mouseenter="focusedIndex = index"
                        >
                            <strong x-text="product.id"></strong> - <span x-text="product.description"></span>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Selected Product Summary -->
        <div x-show="selectedProduct" class="glass-effect rounded-xl overflow-hidden mb-6">
            <div class="bg-blue-600/20 border-b border-blue-600/30 px-6 py-4">
                <h6 class="text-lg font-semibold text-blue-400 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    Selected Product
                </h6>
            </div>
            <div class="p-6">
                <p class="text-gray-300 mb-2"><strong class="text-white">ID:</strong> <span x-text="selectedProduct?.id"></span></p>
                <p class="text-gray-300 mb-2"><strong class="text-white">Description:</strong> <span x-text="selectedProduct?.description"></span></p>
                <p class="text-gray-300 mb-2"><strong class="text-white">Keywords:</strong> <span x-text="selectedProduct?.keywords"></span></p>
                <p class="text-gray-300 mb-2"><strong class="text-white">UPC:</strong> <span x-text="selectedProduct?.upc || 'N/A'"></span></p>
                <p class="text-gray-300 mb-2"><strong class="text-white">Active:</strong> <span x-text="selectedProduct?.is_active ? 'Yes' : 'No'"></span></p>
            </div>
        </div>

        <!-- JSON Display -->
        <div x-show="selectedProduct" class="glass-effect rounded-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h5 class="text-xl font-semibold text-white flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                    </svg>
                    Complete Product JSON Data
                </h5>
                <button
                    @click="copyJSON()"
                    class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white font-medium rounded-lg transition-all flex items-center space-x-2"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                    <span x-text="copied ? 'Copied!' : 'Copy JSON'"></span>
                </button>
            </div>
            <pre class="bg-slate-900/80 border border-slate-700 rounded-lg p-4 overflow-x-auto text-sm text-gray-300 font-mono"><code x-text="formatJSON()"></code></pre>
        </div>

        <!-- Success/Info Messages -->
        <div x-show="message" class="mt-6">
            <div
                :class="messageType === 'success' ? 'bg-green-600/20 border-green-600/50 text-green-400' : 'bg-blue-600/20 border-blue-600/50 text-blue-400'"
                class="px-6 py-4 rounded-lg border text-sm"
            >
                <span x-text="message"></span>
            </div>
        </div>
    </div>
</div>

<script>
    function productSearch() {
        return {
            // Search state
            searchQuery: '',
            searchResults: [],
            focusedIndex: -1,

            // Selected product
            selectedProduct: null,

            // UI state
            message: '',
            messageType: 'success',
            copied: false,

            // Search function with debounce
            async searchProducts() {
                console.log('üîç Searching products for:', this.searchQuery);
                if (this.searchQuery.length < 2) {
                    this.searchResults = [];
                    this.focusedIndex = -1;
                    return;
                }

                try {
                    const response = await fetch(`/products/search/api/?q=${encodeURIComponent(this.searchQuery)}`);
                    const data = await response.json();
                    console.log('üì¶ Search response:', data);
                    console.log('üìä Products found:', data.products?.length || 0);

                    this.searchResults = data.products || [];
                    this.focusedIndex = -1;
                } catch (error) {
                    console.error('‚ùå Search error:', error);
                    this.searchResults = [];
                    this.focusedIndex = -1;
                }
            },

            // Selection function
            selectProduct(product) {
                console.log('‚úÖ Selected product:', product);
                this.selectedProduct = product;
                this.searchResults = [];
                this.searchQuery = `${product.id} - ${product.description}`;
                this.message = `Selected product: ${product.id}`;
                this.messageType = 'success';
                this.copied = false;

                // Clear message after 3 seconds
                setTimeout(() => {
                    this.message = '';
                }, 3000);
            },

            // Clear search
            clearSearch() {
                this.searchQuery = '';
                this.searchResults = [];
                this.selectedProduct = null;
                this.focusedIndex = -1;
                this.message = '';
                this.copied = false;
            },

            // Keyboard navigation
            handleKeydown(event) {
                if (this.searchResults.length === 0) return;

                switch (event.key) {
                    case 'ArrowDown':
                        event.preventDefault();
                        this.focusedIndex = Math.min(this.focusedIndex + 1, this.searchResults.length - 1);
                        break;
                    case 'ArrowUp':
                        event.preventDefault();
                        this.focusedIndex = Math.max(this.focusedIndex - 1, -1);
                        break;
                    case 'Enter':
                        event.preventDefault();
                        if (this.focusedIndex >= 0 && this.focusedIndex < this.searchResults.length) {
                            this.selectProduct(this.searchResults[this.focusedIndex]);
                        }
                        break;
                    case 'Escape':
                        this.searchResults = [];
                        this.focusedIndex = -1;
                        break;
                }
            },

            // Format JSON for display
            formatJSON() {
                if (!this.selectedProduct) return '';
                return JSON.stringify(this.selectedProduct, null, 2);
            },

            // Copy JSON to clipboard
            async copyJSON() {
                if (!this.selectedProduct) return;

                try {
                    const jsonText = this.formatJSON();
                    await navigator.clipboard.writeText(jsonText);
                    this.copied = true;
                    this.message = 'JSON copied to clipboard!';
                    this.messageType = 'success';

                    // Reset copied state after 3 seconds
                    setTimeout(() => {
                        this.copied = false;
                        this.message = '';
                    }, 3000);
                } catch (error) {
                    console.error('‚ùå Copy error:', error);
                    this.message = 'Failed to copy to clipboard';
                    this.messageType = 'error';
                }
            }
        }
    }
</script>
{% endblock %}
